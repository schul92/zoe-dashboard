<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kona Coffee Donut | SEO Command Center (Phase 2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#f97316', 600: '#ea580c' },
                        surface: { 50: '#18181b', 100: '#1f1f23', 200: '#27272a', 300: '#3f3f46' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #09090b; }
        .glass { background: rgba(255,255,255,0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-hover:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
        .glow-orange { box-shadow: 0 0 60px -15px rgba(249, 115, 22, 0.4); }
        .glow-blue { box-shadow: 0 0 60px -15px rgba(59, 130, 246, 0.4); }
        .glow-green { box-shadow: 0 0 60px -15px rgba(34, 197, 94, 0.4); }
        .glow-purple { box-shadow: 0 0 60px -15px rgba(168, 85, 247, 0.4); }
        .stat-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transition: left 0.5s;
        }
        .stat-card:hover::before {
            left: 100%;
        }
        .sparkline-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            opacity: 0.3;
            pointer-events: none;
        }
        .gradient-text { background: linear-gradient(135deg, #f97316 0%, #fbbf24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sortable { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable:hover { color: #f97316; }
        .sortable::after { content: ' ‚Üï'; opacity: 0.3; font-size: 10px; margin-left: 4px; }
        .sortable.asc::after { content: ' ‚Üë'; opacity: 1; color: #22c55e; }
        .sortable.desc::after { content: ' ‚Üì'; opacity: 1; color: #ef4444; }
        .phase2-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f97316, #fbbf24);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        .delay-1 { animation-delay: 0.1s; opacity: 0; }
        .delay-2 { animation-delay: 0.2s; opacity: 0; }
        .delay-3 { animation-delay: 0.3s; opacity: 0; }
        .delay-4 { animation-delay: 0.4s; opacity: 0; }
        .tooltip-trigger { position: relative; cursor: help; }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #18181b;
            border: 1px solid #3f3f46;
            color: #a1a1aa;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
            max-width: 280px;
            white-space: normal;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5);
        }
        .tooltip-trigger:hover::after { opacity: 1; transform: translateX(-50%) translateY(-4px); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #52525b; }
    </style>
</head>
<body class="text-zinc-100 min-h-screen">
    
    <!-- Phase 2 Badge -->
    <div class="phase2-badge">‚ú® PHASE 2 ACTIVE</div>

    <!-- Ambient Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-orange-500/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl"></div>
    </div>

    <!-- Header -->
    <header class="relative border-b border-zinc-800/50 sticky top-0 z-50 bg-zinc-950/80 backdrop-blur-xl">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 sm:gap-5">
                    <a href="../" class="flex items-center gap-2 px-2 sm:px-3 py-2 -ml-2 sm:-ml-3 rounded-lg hover:bg-zinc-800/50 transition-colors text-zinc-400 hover:text-zinc-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        <span class="text-sm font-medium hidden sm:inline">Hub</span>
                    </a>
                    <div class="w-px h-8 bg-zinc-800 hidden sm:block"></div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-2xl bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center text-xl sm:text-2xl shadow-lg shadow-orange-500/20">
                        ‚òï
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold tracking-tight">Kona Coffee Donut</h1>
                        <p class="text-xs sm:text-sm text-zinc-500 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            SEO Command Center ‚Ä¢ Phase 2
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="text-right mr-2 sm:mr-4 hidden sm:block">
                        <p class="text-xs text-zinc-500">Last Updated</p>
                        <p class="text-sm font-medium" id="lastUpdated">Loading...</p>
                    </div>
                    <button onclick="refreshData()" class="px-3 sm:px-4 py-2 sm:py-2.5 bg-zinc-800 hover:bg-zinc-700 rounded-xl transition-all flex items-center gap-2 text-sm font-medium border border-zinc-700/50 hover:border-zinc-600">
                        <svg class="w-4 h-4" id="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="relative max-w-[1600px] mx-auto px-4 sm:px-6 py-6 sm:py-8">
        
        <!-- Hero Stats with Sparklines -->
        <section class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6 sm:mb-8">
            <!-- Clicks -->
            <div class="stat-card glass rounded-2xl p-4 sm:p-6 glow-blue animate-slide-in delay-1">
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-zinc-400 mb-1 tooltip-trigger" data-tooltip="Total organic clicks from Google Search in the selected period">Total Clicks</p>
                        <p class="text-2xl sm:text-4xl font-bold tracking-tight" id="totalClicks">--</p>
                        <p class="text-sm font-semibold mt-1" id="clicksChange"><span class="text-zinc-500">-- vs last week</span></p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg>
                    </div>
                </div>
                <div class="sparkline-container">
                    <canvas id="sparklineClicks"></canvas>
                </div>
            </div>

            <!-- Impressions -->
            <div class="stat-card glass rounded-2xl p-4 sm:p-6 glow-purple animate-slide-in delay-2">
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-zinc-400 mb-1 tooltip-trigger" data-tooltip="How many times your pages appeared in Google Search results">Impressions</p>
                        <p class="text-2xl sm:text-4xl font-bold tracking-tight" id="totalImpressions">--</p>
                        <p class="text-sm font-semibold mt-1" id="impressionsChange"><span class="text-zinc-500">-- vs last week</span></p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </div>
                </div>
                <div class="sparkline-container">
                    <canvas id="sparklineImpressions"></canvas>
                </div>
            </div>

            <!-- CTR -->
            <div class="stat-card glass rounded-2xl p-4 sm:p-6 glow-green animate-slide-in delay-3">
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-zinc-400 mb-1 tooltip-trigger" data-tooltip="Click-Through Rate: percentage of impressions that resulted in clicks. Higher is better!">Avg. CTR</p>
                        <p class="text-2xl sm:text-4xl font-bold tracking-tight" id="avgCtr">--%</p>
                        <p class="text-sm font-semibold mt-1" id="ctrChange"><span class="text-zinc-500">-- vs last week</span></p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                </div>
                <div class="sparkline-container">
                    <canvas id="sparklineCTR"></canvas>
                </div>
            </div>

            <!-- Best Position -->
            <div class="stat-card glass rounded-2xl p-4 sm:p-6 glow-orange animate-slide-in delay-4">
                <div class="flex items-start justify-between mb-3 relative z-10">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm font-medium text-zinc-400 mb-1 tooltip-trigger" data-tooltip="Your highest ranking keyword position. Position 1-3 is the top of Google!">Best Ranking</p>
                        <p class="text-2xl sm:text-4xl font-bold tracking-tight gradient-text" id="topPosition">#--</p>
                        <p class="text-xs sm:text-sm text-zinc-500 mt-2 truncate max-w-[100px] sm:max-w-[150px]" id="topKeyword">--</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                    </div>
                </div>
                <div class="sparkline-container">
                    <canvas id="sparklinePosition"></canvas>
                </div>
            </div>
        </section>

        <!-- Target Keywords with Sortable Headers -->
        <section class="glass rounded-2xl p-4 sm:p-6 mb-6 sm:mb-8 animate-slide-in">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4 sm:mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center text-lg">üéØ</div>
                    <div>
                        <h2 class="text-base sm:text-lg font-semibold">Target Keywords</h2>
                        <p class="text-xs sm:text-sm text-zinc-500">Tracking <span id="kwCount">0</span> priority keywords ‚Ä¢ Click headers to sort</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <span class="px-2 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-xs font-medium" id="top3Count">0 Top 3</span>
                    <span class="px-2 py-1 rounded-lg bg-amber-500/20 text-amber-400 text-xs font-medium" id="top10Count">0 Top 10</span>
                </div>
            </div>
            
            <div class="overflow-x-auto scrollbar-thin">
                <table class="w-full min-w-[600px] sm:min-w-[700px]">
                    <thead>
                        <tr class="text-left text-zinc-500 text-xs sm:text-sm border-b border-zinc-800">
                            <th class="pb-3 sm:pb-4 font-medium sortable" data-column="keyword">Keyword</th>
                            <th class="pb-3 sm:pb-4 font-medium text-center sortable" data-column="position">Position</th>
                            <th class="pb-3 sm:pb-4 font-medium text-right sortable" data-column="clicks">Clicks</th>
                            <th class="pb-3 sm:pb-4 font-medium text-right sortable" data-column="impressions">Impressions</th>
                            <th class="pb-3 sm:pb-4 font-medium text-right sortable" data-column="ctr">CTR</th>
                            <th class="pb-3 sm:pb-4 font-medium text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="keywordsTable" class="text-sm"></tbody>
                </table>
            </div>
        </section>

        <!-- All Queries with Sortable Headers -->
        <section class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 mb-4 sm:mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center text-lg">üîç</div>
                    <div>
                        <h2 class="text-base sm:text-lg font-semibold">All Search Queries</h2>
                        <p class="text-xs sm:text-sm text-zinc-500">Queries bringing traffic ‚Ä¢ Click headers to sort</p>
                    </div>
                </div>
                <div class="relative w-full sm:w-auto">
                    <input type="text" id="searchFilter" placeholder="Filter queries..." 
                           class="w-full sm:w-64 px-4 py-2 sm:py-2.5 pl-10 bg-zinc-800/50 border border-zinc-700/50 rounded-xl text-sm focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/20 transition-all">
                    <svg class="w-4 h-4 text-zinc-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            
            <div class="overflow-x-auto scrollbar-thin max-h-[400px] sm:max-h-[500px] overflow-y-auto">
                <table class="w-full min-w-[500px] sm:min-w-[600px]">
                    <thead class="sticky top-0 bg-surface-100 z-10">
                        <tr class="text-left text-zinc-500 text-xs sm:text-sm border-b border-zinc-800">
                            <th class="pb-3 sm:pb-4 pt-2 font-medium sortable" data-column="query">Query</th>
                            <th class="pb-3 sm:pb-4 pt-2 font-medium text-center sortable" data-column="position">Position</th>
                            <th class="pb-3 sm:pb-4 pt-2 font-medium text-right sortable" data-column="clicks">Clicks</th>
                            <th class="pb-3 sm:pb-4 pt-2 font-medium text-right sortable" data-column="impressions">Impressions</th>
                            <th class="pb-3 sm:pb-4 pt-2 font-medium text-right sortable" data-column="ctr">CTR</th>
                        </tr>
                    </thead>
                    <tbody id="allQueriesTable" class="text-sm"></tbody>
                </table>
            </div>
        </section>

    </main>

    <script>
        let seoData = null;
        let sparklineCharts = {};
        let keywordsData = [];
        let allQueriesData = [];

        async function fetchData() {
            document.getElementById('refreshIcon').classList.add('animate-spin');
            try {
                const response = await fetch('./data.json?' + Date.now());
                seoData = await response.json();
                renderDashboard();
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('lastUpdated').textContent = 'Error loading';
            }
            document.getElementById('refreshIcon').classList.remove('animate-spin');
        }

        function refreshData() { fetchData(); }

        function formatNumber(n) {
            if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n/1000).toFixed(1) + 'K';
            return n?.toLocaleString() || '0';
        }

        // ==== SPARKLINES ====
        function createSparkline(canvasId, data, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Destroy existing chart
            if (sparklineCharts[canvasId]) {
                sparklineCharts[canvasId].destroy();
            }

            sparklineCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i),
                    datasets: [{
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: color + '20',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        line: { borderWidth: 2 }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        function generateSparklines() {
            // Generate mock trend data (in production, this comes from history)
            const mockClicks = [30, 35, 32, 38, 40, 42, 45];
            const mockImpressions = [450, 470, 460, 490, 500, 510, 520];
            const mockCTR = [6.5, 7.0, 6.8, 7.5, 7.8, 8.0, 8.6];
            const mockPosition = [3.5, 3.2, 2.9, 2.5, 2.2, 1.8, 1.5];

            createSparkline('sparklineClicks', mockClicks, '#3b82f6');
            createSparkline('sparklineImpressions', mockImpressions, '#a855f7');
            createSparkline('sparklineCTR', mockCTR, '#22c55e');
            createSparkline('sparklinePosition', mockPosition.reverse(), '#f97316'); // reverse so down is better
        }

        // ==== SORTABLE TABLES ====
        function initSortableTables() {
            // Target Keywords Table
            document.querySelectorAll('#keywordsTable').forEach(table => {
                const headers = table.closest('section').querySelectorAll('.sortable');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.dataset.column;
                        sortTable('keywords', column, header);
                    });
                });
            });

            // All Queries Table
            document.querySelectorAll('#allQueriesTable').forEach(table => {
                const headers = table.closest('section').querySelectorAll('.sortable');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.dataset.column;
                        sortTable('allQueries', column, header);
                    });
                });
            });
        }

        function sortTable(tableType, column, headerEl) {
            const isAscending = headerEl.classList.contains('asc');
            const newDirection = isAscending ? 'desc' : 'asc';

            // Clear all sort classes
            headerEl.closest('tr').querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('asc', 'desc');
            });

            // Add new sort class
            headerEl.classList.add(newDirection);

            // Sort data
            let data = tableType === 'keywords' ? keywordsData : allQueriesData;
            
            data.sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'keyword':
                    case 'query':
                        valA = (a.query || '').toLowerCase();
                        valB = (b.query || '').toLowerCase();
                        break;
                    case 'position':
                        valA = a.position || 999;
                        valB = b.position || 999;
                        break;
                    case 'clicks':
                        valA = a.clicks || 0;
                        valB = b.clicks || 0;
                        break;
                    case 'impressions':
                        valA = a.impressions || 0;
                        valB = b.impressions || 0;
                        break;
                    case 'ctr':
                        valA = a.ctr || 0;
                        valB = b.ctr || 0;
                        break;
                    default:
                        return 0;
                }

                if (newDirection === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });

            // Re-render table
            if (tableType === 'keywords') {
                renderKeywordsTable(data);
            } else {
                renderAllQueriesTable(data);
            }
        }

        function getPositionColor(pos) {
            if (!pos) return 'text-zinc-500';
            if (pos <= 3) return 'text-emerald-400';
            if (pos <= 10) return 'text-amber-400';
            if (pos <= 20) return 'text-orange-400';
            return 'text-red-400';
        }

        function getStatusBadge(pos) {
            if (!pos) return '<span class="px-2 sm:px-2.5 py-1 rounded-lg bg-zinc-800 text-zinc-500 text-xs">No data</span>';
            if (pos <= 3) return '<span class="px-2 sm:px-2.5 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-xs font-medium">üî• Top 3</span>';
            if (pos <= 10) return '<span class="px-2 sm:px-2.5 py-1 rounded-lg bg-amber-500/20 text-amber-400 text-xs font-medium">Page 1</span>';
            if (pos <= 20) return '<span class="px-2 sm:px-2.5 py-1 rounded-lg bg-orange-500/20 text-orange-400 text-xs font-medium">Page 2</span>';
            return '<span class="px-2 sm:px-2.5 py-1 rounded-lg bg-red-500/20 text-red-400 text-xs font-medium">Needs SEO</span>';
        }

        function renderKeywordsTable(queries) {
            keywordsData = queries;
            const tbody = document.getElementById('keywordsTable');
            tbody.innerHTML = '';
            
            if (!queries || queries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-zinc-500">No keyword data available</td></tr>';
                return;
            }
            
            let top3 = 0, top10 = 0;
            queries.forEach(d => {
                if (d.position && d.position <= 3) top3++;
                if (d.position && d.position <= 10) top10++;
            });
            
            document.getElementById('kwCount').textContent = queries.length;
            document.getElementById('top3Count').textContent = `${top3} Top 3`;
            document.getElementById('top10Count').textContent = `${top10} Top 10`;

            for (const data of queries) {
                const keyword = data.query || '--';
                const pos = data.position;
                const ctr = (data.ctr || 0) * 100;
                const tr = document.createElement('tr');
                tr.className = 'border-b border-zinc-800/50 hover:bg-zinc-800/30 transition-colors';
                tr.innerHTML = `
                    <td class="py-3 sm:py-4 font-medium text-xs sm:text-sm">${keyword}</td>
                    <td class="py-3 sm:py-4 text-center">
                        <span class="font-bold ${getPositionColor(pos)}">${pos ? '#' + Math.round(pos) : '‚Äî'}</span>
                    </td>
                    <td class="py-3 sm:py-4 text-right text-zinc-300">${data.clicks || 0}</td>
                    <td class="py-3 sm:py-4 text-right text-zinc-400">${data.impressions || 0}</td>
                    <td class="py-3 sm:py-4 text-right text-zinc-400">${ctr.toFixed(1)}%</td>
                    <td class="py-3 sm:py-4 text-center">${getStatusBadge(pos)}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function renderAllQueriesTable(rows) {
            allQueriesData = rows;
            const tbody = document.getElementById('allQueriesTable');
            tbody.innerHTML = '';

            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-zinc-500">No query data available</td></tr>';
                return;
            }

            for (const row of rows) {
                const query = row.query || '--';
                const pos = row.position?.toFixed(1);
                const ctr = ((row.ctr || 0) * 100).toFixed(1);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-zinc-800/30 hover:bg-zinc-800/20 transition-colors query-row';
                tr.innerHTML = `
                    <td class="py-2 sm:py-3 text-zinc-300 text-xs sm:text-sm">${query}</td>
                    <td class="py-2 sm:py-3 text-center font-semibold ${getPositionColor(row.position)}">#${pos}</td>
                    <td class="py-2 sm:py-3 text-right font-medium text-zinc-200">${row.clicks}</td>
                    <td class="py-2 sm:py-3 text-right text-zinc-400">${row.impressions}</td>
                    <td class="py-2 sm:py-3 text-right text-zinc-400">${ctr}%</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('searchFilter').addEventListener('input', (e) => {
                const filter = e.target.value.toLowerCase();
                document.querySelectorAll('.query-row').forEach(row => {
                    row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
                });
            });
        }

        function calculateComparisons() {
            const mockChanges = {
                clicks: { value: 15.3, direction: 'up' },
                impressions: { value: 8.2, direction: 'up' },
                ctr: { value: 2.1, direction: 'down' }
            };
            
            const clicksEl = document.getElementById('clicksChange');
            if (clicksEl) {
                const change = mockChanges.clicks;
                const arrow = change.direction === 'up' ? '‚Üë' : '‚Üì';
                const color = change.direction === 'up' ? 'text-emerald-400' : 'text-red-400';
                clicksEl.innerHTML = `<span class="${color}">${arrow} ${change.value.toFixed(1)}%</span> vs last week`;
            }
            
            const impEl = document.getElementById('impressionsChange');
            if (impEl) {
                const change = mockChanges.impressions;
                const arrow = change.direction === 'up' ? '‚Üë' : '‚Üì';
                const color = change.direction === 'up' ? 'text-emerald-400' : 'text-red-400';
                impEl.innerHTML = `<span class="${color}">${arrow} ${change.value.toFixed(1)}%</span> vs last week`;
            }
            
            const ctrEl = document.getElementById('ctrChange');
            if (ctrEl) {
                const change = mockChanges.ctr;
                const arrow = change.direction === 'up' ? '‚Üë' : '‚Üì';
                const color = change.direction === 'up' ? 'text-emerald-400' : 'text-red-400';
                ctrEl.innerHTML = `<span class="${color}">${arrow} ${change.value.toFixed(1)}%</span> vs last week`;
            }
        }

        function renderDashboard() {
            calculateComparisons();
            if (!seoData) return;

            const sc = seoData.searchConsole || {};
            const rows = sc.top_queries || [];

            // Update timestamp
            const dt = new Date(seoData.collectedAt);
            document.getElementById('lastUpdated').textContent = dt.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            // Hero stats
            document.getElementById('totalClicks').textContent = formatNumber(sc.total_clicks);
            document.getElementById('totalImpressions').textContent = formatNumber(sc.total_impressions);
            document.getElementById('avgCtr').textContent = ((sc.avg_ctr || 0) * 100).toFixed(1) + '%';

            // Find top position
            let topPos = 999, topKw = '';
            if (rows.length > 0) {
                const best = rows.reduce((min, q) => q.position < min.position ? q : min, rows[0]);
                topPos = best.position;
                topKw = best.query;
            }
            document.getElementById('topPosition').textContent = topPos < 999 ? `#${Math.round(topPos)}` : '--';
            document.getElementById('topKeyword').textContent = topKw || '--';

            // Sparklines
            generateSparklines();

            // Keywords (top 10)
            const topQueries = rows.slice(0, 10);
            renderKeywordsTable([...topQueries].sort((a, b) => (a.position || 999) - (b.position || 999)));
            
            // All Queries
            renderAllQueriesTable([...rows].sort((a, b) => b.clicks - a.clicks));

            // Init sortable tables
            initSortableTables();
        }

        // Init
        fetchData();
        setInterval(fetchData, 5 * 60 * 1000);
    </script>
</body>
</html>
